<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Emoji Charades ‚Äî Movies</title>
<style>
  :root{
    --bg1:#0d1024; --bg2:#2a3570; --bg3:#6a39b8; --bg4:#293a8f;
    --glass:rgba(255,255,255,.12); --glass2:rgba(255,255,255,.18);
    --text:#ffffff; --accent:#ffd400; --chip:#2c356e; --chipBorder:rgba(255,255,255,.28);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1200px 700px at 50% -250px, rgba(140,80,255,.24), transparent),
      linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 35%, var(--bg4) 65%, var(--bg3) 100%);
    -webkit-tap-highlight-color:transparent;
    overflow-x:hidden;
  }

  #edgeLights{position:fixed; inset:0; pointer-events:none; z-index:1}

  .windows{
    position:fixed; inset:0; z-index:0; pointer-events:none;
    display:grid; grid-template-columns:repeat(10,1fr); gap:10px;
    padding:22px; opacity:.27;
  }
  .win{
    border-radius:12px;
    background:
      linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05)),
      radial-gradient(120% 100% at 20% 10%, rgba(255,255,255,.07), transparent 60%);
    border:1px solid rgba(255,255,255,.14);
    position:relative; overflow:hidden;
    backdrop-filter:blur(2px);
  }
  .win::after{
    content: attr(data-e);
    position:absolute; inset:0; display:grid; place-items:center;
    font-size:clamp(10px, 3vmin, 26px);
    opacity:.0; animation:peek 6s linear infinite;
  }
  @keyframes peek{0%,70%{opacity:0;transform:scale(.9)}75%,90%{opacity:.8;transform:scale(1)}100%{opacity:0;transform:scale(.95)}}

  .wrap{
    position:relative; z-index:2;
    min-height:100%;
    display:grid; grid-template-rows:auto auto 1fr auto;
    gap:12px; padding:16px; max-width:1100px; margin:0 auto;
  }

  header{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; text-align:center}
  h1{
    font-weight:900; letter-spacing:.3px; font-size:clamp(20px,5vmin,44px); color:var(--accent);
    text-shadow:0 1px 0 rgba(0,0,0,.35),0 2px 0 rgba(0,0,0,.25),0 0 12px rgba(255,212,0,.45),0 0 24px rgba(255,212,0,.35);
  }
  .ctrl-right{display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap}
  .pill{
    padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.25);
    background:var(--glass); font-weight:700; cursor:pointer; color:#fff;
    transition:transform .08s ease, filter .15s ease;
  }
  .pill:hover{filter:brightness(1.08)} .pill:active{transform:translateY(1px) scale(.99)}

  .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:center; margin-top:-2px; padding:2px 0 4px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chipBorder); font-weight:800; font-size:14px}
  .chip button{appearance:none; border:0; width:20px; height:20px; border-radius:999px; display:grid; place-items:center; background:rgba(255,255,255,.15); color:#fff; cursor:pointer}

  main{display:grid; grid-template-columns:1fr; gap:14px;}
  .board{
    display:grid; gap:14px; background:var(--glass); border:1px solid rgba(255,255,255,.25);
    border-radius:18px; padding:16px; backdrop-filter:blur(10px);
    box-shadow:0 12px 40px rgba(0,0,0,.28), 0 0 0 1px rgba(255,255,255,.06) inset;
  }
  .toprow{display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:8px}
  .center{display:none} /* (5) hide category heading */

  /* bubbles same width for counter, timer, hint */
  .timer,.tag,.hint{
    min-width:150px; text-align:center; font-weight:700; font-size:clamp(8px,2.6vmin,18px);
    padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.25); background:var(--glass2);
    box-shadow:0 4px 12px rgba(0,0,0,.18);
  }
  .tag{font-weight:900; font-size:clamp(8px,2.4vmin,16px)}
  .metaR{display:flex; gap:8px; justify-content:flex-end; align-items:center}

  .emoji{font-size:clamp(54px,12.5vmin,120px); line-height:1.1; text-align:center; white-space:pre-wrap; text-shadow:0 5px 16px rgba(0,0,0,.5); padding:10px 8px}

  .clapperWrap{display:grid; place-items:center; min-height:120px}
  .clapper{
    position:relative; width:min(780px,92%); border-radius:14px; background:linear-gradient(180deg,rgba(0,0,0,.78),rgba(0,0,0,.60));
    border:1px solid rgba(255,255,255,.25);
    box-shadow:0 14px 40px rgba(0,0,0,.35), 0 0 12px rgba(99,247,255,.25), 0 0 22px rgba(166,255,143,.18);
    transform:translateY(8px); opacity:0; transition:opacity .3s ease, transform .3s ease;
  }
  .clapper.show{opacity:1; transform:translateY(0)}
  .clap-top{position:absolute; left:0; right:0; top:-40px; height:40px; background:repeating-linear-gradient(135deg,#fff 0 18px,#111 18px 36px); border-radius:8px 8px 0 0; transform-origin:left bottom; transform:rotate(-28deg); box-shadow:0 10px 20px rgba(0,0,0,.4); animation:clack .55s ease-out forwards}
  @keyframes clack{0%{transform:rotate(-28deg)}100%{transform:rotate(-4deg)}}
  .clap-body{padding:18px 16px; text-align:center}
  .movieTitle{color:var(--accent); font-weight:900; letter-spacing:.4px; font-size:clamp(20px,4.8vmin,36px); text-shadow:0 3px 12px rgba(255,212,0,.55)}

  .controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:4px}
  .controls .pill{min-width:150px; text-align:center; font-size:18px} /* (3) bigger buttons */

  /* 3D / neon only for bottom buttons */
  .btn3d{
    background:
      linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06)) ,
      var(--glass);
    border:1px solid rgba(255,255,255,.28);
    box-shadow:
      0 10px 18px rgba(0,0,0,.35),
      0 0 10px rgba(255,212,0,.18),
      inset 0 1px 0 rgba(255,255,255,.25),
      inset 0 -4px 12px rgba(0,0,0,.25);
    text-shadow:0 1px 0 rgba(0,0,0,.35);
    transition:transform .06s ease, box-shadow .12s ease, filter .15s ease;
  }
  .btn3d:hover{filter:brightness(1.1); box-shadow:
      0 14px 24px rgba(0,0,0,.38),
      0 0 14px rgba(255,212,0,.28),
      inset 0 1px 0 rgba(255,255,255,.28),
      inset 0 -4px 12px rgba(0,0,0,.28);}
  .btn3d:active{
    transform:translateY(2px);
    box-shadow:
      0 6px 12px rgba(0,0,0,.35),
      0 0 8px rgba(255,212,0,.22),
      inset 0 1px 0 rgba(255,255,255,.18),
      inset 0 -2px 8px rgba(0,0,0,.35);
  }

  footer{opacity:.9; font-size:14px; text-align:center; padding-bottom:8px}

  /* Modals */
  #rulesModal,#catsModal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9}
  .modal-card{
    width:min(720px,92vw); max-height:82vh; overflow:auto; background:linear-gradient(135deg,rgba(60,60,90,.95),rgba(30,30,55,.95));
    border-radius:16px; border:1px solid rgba(255,255,255,.25); padding:18px 20px; box-shadow:0 20px 50px rgba(0,0,0,.55)
  }
  .cats-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin:10px 0 6px}
  .cat-item{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; background:var(--glass2); border:1px solid rgba(255,255,255,.25)}
  .modal-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .rules-card ul{margin-left:18px; line-height:1.45}
  .limits{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; justify-content:center}
  .limit-pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; cursor:pointer; background:var(--glass2); border:1px solid rgba(255,255,255,.3); font-weight:800}
  .limit-pill input{accent-color:#ffd400}
  .tools-row{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 2px; justify-content:center}
  .subtle{opacity:.8; font-size:14px; text-align:center}
  @media (max-width:640px){ .controls .pill{min-width:140px} .cats-grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <canvas id="edgeLights"></canvas>
  <div class="windows" aria-hidden="true"></div>

  <div class="wrap">
    <header>
      <h1>Emoji Charades ‚Äî Movies</h1>
      <div class="ctrl-right">
        <div class="pill">Space: Reveal ‚Ä¢ Double-Space: Next</div>
        <button id="musicBtn" class="pill">Music: On</button>
        <button id="styleBtn" class="pill">Style: Fun Beat</button>
        <button id="shuffleBtn" class="pill">Shuffle</button>
        <button id="catsBtn" class="pill">Categories & Rounds</button>
        <button id="rulesBtn" class="pill">Rules</button>
      </div>
    </header>

    <div id="activeCats" class="chips" aria-label="Active categories"></div>

    <main>
      <section class="board" aria-live="polite">
        <div class="toprow">
          <div class="metaL"><div id="progress" class="tag">1 / 150</div></div>
          <div class="center"><div id="category" class="category">Category: ‚Äî</div></div> <!-- hidden by CSS -->
          <div class="metaR">
            <div id="clock" class="timer">‚è±Ô∏è ‚Äî</div>
            <div id="hint" class="hint">HINT: ‚Äî</div>
          </div>
        </div>

        <div id="emoji" class="emoji">üé¨üòÄ</div>

        <div class="clapperWrap">
          <div id="clapper" class="clapper" aria-hidden="true">
            <div class="clap-top"></div>
            <div class="clap-body"><div id="movieTitle" class="movieTitle">‚Äî</div></div>
          </div>
        </div>

        <div class="controls">
          <button id="reveal"  class="pill btn3d">Reveal Answer</button>
          <button id="nextBtn" class="pill btn3d">Next</button>
          <button id="skip"    class="pill btn3d">Skip</button>
          <button id="restart" class="pill btn3d">Restart</button>
        </div>
      </section>
    </main>

    <footer>Family-friendly ‚Ä¢ Projector & Mobile ready ‚Ä¢ English ‚Ä¢ Hindi ‚Ä¢ Kannada ‚Ä¢ Telugu ‚Ä¢ Malayalam ‚Ä¢ Tamil</footer>
  </div>

  <!-- Rules modal -->
  <div id="rulesModal">
    <div class="modal-card rules-card">
      <h3>Emoji Charades ‚Äî Quick Rules</h3>
      <ul>
        <li>Each round shows emojis for a <b>popular movie</b>. Languages: <b>English, Hindi, Kannada, Telugu, Malayalam, Tamil</b>.</li>
        <li>Use <b>Categories & Rounds</b> to set languages, round size (10/20/30), and timer (10s/12s/15s/20s).</li>
        <li><b>Space</b> = Reveal ‚Ä¢ <b>Double-Space</b> = Next.</li>
      </ul>
      <div class="modal-actions">
        <button id="rulesClose" class="pill rules-close">Close</button>
      </div>
    </div>
  </div>

  <!-- Categories & Rounds modal (opens first on load) -->
  <div id="catsModal">
    <div class="modal-card">
      <h3 style="text-align:center">Choose Categories & Rounds</h3>
      <div class="tools-row">
        <button id="catsAll"  class="pill">Select all</button>
        <button id="catsNone" class="pill">Clear all</button>
      </div>
      <div class="cats-grid" id="catsGrid"></div>

      <p class="subtle" style="margin-top:6px">Rounds (how many movies to play this session):</p>
      <div class="limits">
        <label class="limit-pill"><input type="radio" name="limit" value="10"> 10</label>
        <label class="limit-pill"><input type="radio" name="limit" value="20"> 20</label>
        <label class="limit-pill"><input type="radio" name="limit" value="30"> 30</label>
      </div>

      <!-- Timer picker -->
      <p class="subtle" style="margin-top:10px">Timer per puzzle:</p>
      <div class="limits" id="timerOptions">
        <label class="limit-pill"><input type="radio" name="timer" value="10"> 10s</label>
        <label class="limit-pill"><input type="radio" name="timer" value="12"> 12s</label>
        <label class="limit-pill"><input type="radio" name="timer" value="15"> 15s</label>
        <label class="limit-pill"><input type="radio" name="timer" value="20"> 20s</label>
      </div>

      <div class="modal-actions">
        <button id="catsCancel" class="pill">Cancel</button>
        <button id="catsApply" class="pill">Apply & Start</button>
      </div>
    </div>
  </div>

<script>
/* ========= Movies ========= */
/* Existing + 20 more per language (no duplicates with prior list) */
const MOVIES = [
  /* Hindi (existing) */
  {t:"3 Idiots", e:"üéìüß†üì∏üìöüë¶üë¶üë¶üìèüõµüë©‚Äç‚öïÔ∏è", c:"Hindi movie"},
  {t:"Dangal", e:"ü•áü§º‚Äç‚ôÄÔ∏èüë®‚Äçüëß‚Äçüëß", c:"Hindi movie"},
  {t:"Pathaan", e:"üï∂Ô∏èüõ©Ô∏è‚ùÑÔ∏èüí•", c:"Hindi movie"},
  {t:"Jawan", e:"üõ§Ô∏èüï∂Ô∏èüé≠üí•", c:"Hindi movie"},
  {t:"BrahmƒÅstra", e:"üî•ü™Ñüî±üåå ", c:"Hindi movie"},
  {t:"Gully Boy", e:"üé§üß¢üöáüî•", c:"Hindi movie"},
  /* Hindi (+20) */
  {t:"Animal", e:"üêØü©∏‚öîÔ∏è", c:"Hindi movie"},
  {t:"Gadar 2", e:"üáÆüá≥üöÇüí•", c:"Hindi movie"},
  {t:"Dunki", e:"‚úàÔ∏èüåçüë¥üèªüòÇ", c:"Hindi movie"},
  {t:"Shershaah", e:"üéñÔ∏èüèîÔ∏èüáÆüá≥", c:"Hindi movie"},
  {t:"Andhadhun", e:"üéπüòµ‚Äçüí´üï∂Ô∏è", c:"Hindi movie"},
  {t:"Stree", e:"üëªüèòÔ∏èüòÇ", c:"Hindi movie"},
  {t:"Article 15", e:"üëÆ‚Äç‚ôÇÔ∏èüìú‚öñÔ∏èüßë‚Äç‚öñÔ∏è", c:"Hindi movie"},
  {t:"Drishyam 2 (Hin)", e:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶üìºüöóüëÆüïµÔ∏è", c:"Hindi movie"},
  {t:"Rocky Aur Rani Kii Prem Kahaani", e:"üíÉüì∞üï∫üöò‚ù§Ô∏èüëó", c:"Hindi movie"},
  {t:"12th Fail", e:"üìöüìùüëÆ", c:"Hindi movie"},
  {t:"PK", e:"üõ∏üëΩ‚ùìüî∑", c:"Hindi movie"},
  {t:"OMG", e:"üïâÔ∏èüìöüë®‚Äçüè´", c:"Hindi movie"},
  {t:"Bhool Bhulaiyaa 2", e:"üèöÔ∏èüëªüòÇ", c:"Hindi movie"},
  {t:"Tiger 3", e:"üêØüïµÔ∏è‚Äç‚ôÇÔ∏èüí•", c:"Hindi movie"},
  {t:"Sooryavanshi", e:"üåûüöîüí•üöóüí•üöòüí•üöìüí•üèçÔ∏èüí•", c:"Hindi movie"},
  {t:"Crew", e:"‚úàÔ∏èüë©‚Äç‚úàÔ∏èüë©‚Äç‚úàÔ∏èüë©‚Äç‚úàÔ∏èü™ôü™ôü™ôüíÑüíÖ", c:"Hindi movie"},
  {t:"Munjya", e:"üëªüå¥üòàüòÇ", c:"Hindi movie"},
  {t:"Laapataa Ladies", e:"üë∞üèºüë∞üèºüöåüîçüëÆ", c:"Hindi movie"},
  {t:"Bhediya", e:"üåïüê∫üß™", c:"Hindi movie"},
  {t:"Hera Pheri", e:"‚òéÔ∏èüí∏ü•∏ü§†ü§ì", c:"Hindi movie"},

  /* English (existing) */
   {t:"Dune", e:"üßôüêâüé¨üèúÔ∏è", c:"English movie"},
  {t:"Inside Out", e:"üòÄüò¢üò†üò®ü§¢üß†", c:"English movie"},
  {t:"Guardians of the Galaxy", e:"üéµüöÄüßôüåä", c:"English movie"},
  {t:"Spider-Man: Across the Spider-Verse", e:"üï∑Ô∏èüé¨üåüüß†", c:"English movie"},
  {t:"Avatar", e:"üßôüåäüéµüßú‚Äç‚ôÄÔ∏è", c:"English movie"},
  {t:"John Wick", e:"ü¶áüé¨üß†üéµ", c:"English movie"},
  {t:"Mission: Impossible ‚Äì Fallout", e:"üßôüé¨üï∑Ô∏èüß†", c:"English movie"},
  {t:"Black Panther", e:"üï∑Ô∏èüêÖüëëüåü", c:"English movie"},
  {t:"Coco", e:"üéµüé∏üíÄ‚ò†Ô∏èüíÄ‚ò†Ô∏èüíÄ‚ò†Ô∏è", c:"English movie"},
  {t:"Ratatouille", e:"üêÄüçùüë®üèº‚Äçüç≥", c:"English movie"},
  {t:"Up", e:"üè†ü™Çüë¥üèºüë∂üèºü¶öüêï", c:"English movie"},
  {t:"Toy Story", e:"üß∏ü™Äü¶∏üèΩü•îü•îüé¨üåü", c:"English movie"},
  {t:"Finding Nemo", e:"üåäüê†üê°üê°üîç", c:"English movie"},
  {t:"Finding Dory", e:"üåäüîçüê†", c:"English movie"},
  {t:"The Incredibles", e:"ü¶∏ü¶∏ü¶∏ü¶∏ü¶∏üåü", c:"English movie"},
  {t:"Frozen", e:"üë©‚Äçüë¶ü•∂‚ùÑÔ∏è‚õÑ", c:"English movie"},
  {t:"Frozen II", e:"üë©‚Äçüë¶ü•∂‚ùÑÔ∏è‚õÑü¶¨üßëüèª‚Äç‚ù§Ô∏è‚Äçüë©üèª", c:"English movie"},
  {t:"Moana", e:"üåäüü¢üëµüèºüëßüèΩüí™üèΩüë®üèΩ‚Äçü¶±üå¥üêìü••", c:"English movie"},
  {t:"Encanto", e:"üéµüé¨üß†üåüüëµüèºüëßüèºüë®üèΩ‚Äçü¶±üëßüèΩüßëüèª‚Äç‚ù§Ô∏è‚Äçüë©üèªü™ÑüèØ", c:"English movie"},
  {t:"Zootopia", e:"ü¶äüê∞ü¶Åüêèü´éüêòüßòüèΩ‚Äç‚ôÄÔ∏è", c:"English movie"},
  {t:"The Lion King", e:"ü¶Åüëëü¶Å", c:"English movie"},
  {t:"Aladdin (2019)", e:"üßôü™îüê´üåµüèúÔ∏èüèùÔ∏èüåº", c:"English movie"},
  {t:"Beauty and the Beast", e:"üè∞üëøüëßüèªü¶¨üìö", c:"English movie"},
  {t:"Cinderella (2015)", e:"üëëüéÉü™Ñüßùüèªüëßüèªüëë", c:"English movie"},
  {t:"Harry Potter and the Sorcerer's Stone", e:"ü™Ñü™Ñü™Ñü¶âüßôüèª", c:"English movie"},
  {t:"Harry Potter and the Chamber of Secrets", e:"ü™Ñü™Ñü™Ñü¶âüêç", c:"English movie"},
  {t:"Harry Potter and the Prisoner of Azkaban", e:"ü™Ñü™Ñü™Ñü¶âüßîüèª‚Äç‚ôÇÔ∏èüê∫", c:"English movie"},
  {t:"Harry Potter and the Goblet of Fire", e:"ü™Ñü™Ñü™Ñü¶âüî•üê≤", c:"English movie"},
  {t:"Harry Potter and the Half-Blood Prince", e:"ü™Ñü™Ñü™Ñü¶âüåìü©∏üëë", c:"English movie"},
  {t:"Harry Potter and the Deathly Hallows: Part 1", e:"ü™Ñü™Ñüßëüèª‚Äç‚ù§Ô∏è‚Äçüë©üèªü™Ñü¶âüë¥üèªüßôüèª‚Äç‚ôÇÔ∏èüòµ", c:"English movie"},
  {t:"Harry Potter and the Deathly Hallows: Part 2", e:"ü™Ñüí•ü™Ñüí•ü™Ñü¶âü•≥", c:"English movie"},
  {t:"The Lord of the Rings: The Fellowship of the Ring", e:"üíçüíçüêâüé¨üè∞üßô", c:"English movie"},
  {t:"The Lord of the Rings: The Two Towers", e:"üíçüíçüêâüé¨üè∞üßô", c:"English movie"},
  {t:"The Lord of the Rings: The Return of the King", e:"üíçüíçüêâüé¨üè∞üëë", c:"English movie"},
  {t:"Jurassic Park", e:"ü¶ñüé¨üåüüçø", c:"English movie"},
  {t:"Home Alone", e:"üè†üö∂üèª‚Äç‚û°Ô∏è", c:"English movie"},
  {t:"Ghostbusters", e:"ü¶áüíÄ‚ò†Ô∏èüí•", c:"English movie"},
  {t:"The Karate Kid", e:"ü•ãüë∂üèª", c:"English movie"},
  {t:"Matilda", e:"üëßüèΩüéÇüè´üöóü™Ñ", c:"English movie"},
  {t:"Shrek", e:"üëΩüë∫üôçüèΩ‚Äç‚ôÄÔ∏è", c:"English movie"},
  {t:"How to Train Your Dragon", e:"üßëüèΩ‚Äçüè´üê≤", c:"English movie"},
  {t:"Kung Fu Panda", e:"üêºü•ãüêÖüêçüôàü¶¢üê∞üê¢", c:"English movie"},
  {t:"Kung Fu Panda 2", e:"üêºü•ãüêÖüêçüôàü¶¢üê∞üê¢ü¶ö", c:"English movie"},
  {t:"Kung Fu Panda 3", e:"üêºü•ãüêÖüêçüôàü¶¢üê∞üê¢üêÇüêÇ", c:"English movie"},
  {t:"The Secret Life of Pets", e:"üêïüê∂üêï‚Äçü¶∫üê©üêàüêà‚Äç‚¨õ", c:"English movie"},
  {t:"La La Land", e:"üé∂üé∂üèùÔ∏èüíÉüèΩüï∫üèΩ", c:"English movie"},
  {t:"The Sound of Music", e:"üéµüé¨üåü‚ú®", c:"English movie"},
  {t:"Enchanted", e:"üßôüèØüßîüèΩ‚Äç‚ôÇÔ∏èüë®üèΩüë®üèΩ‚Äçü¶∞üë®üèΩ‚Äçü¶±üëµüèΩüë©üèΩüë©üèΩ‚Äçü¶±üßîüèΩ‚Äç‚ôÄÔ∏èüë©üèΩ", c:"English movie"},
  {t:"The Princess Diaries", e:"üëëüë©üèΩüë®üèΩüìï", c:"English movie"},
  {t:"Pirates of the Caribbean", e:"üè¥‚Äç‚ò†Ô∏è‚öìüö¢üåä", c:"English movie"},

  
  /* Kannada (existing) */
  {t:"Kantara", e:"üåæüõïüï∫üî•", c:"Kannada movie"},
  {t:"777 Charlie", e:"üê∂üöó‚ù§Ô∏è", c:"Kannada movie"},
  {t:"KGF Chapter 2", e:"‚õèÔ∏èüëëüí∞ü™ôü™ôü™ôü™ô‚öîÔ∏è", c:"Kannada movie"},
  /* Kannada (+20) */
  {t:"K.G.F: Chapter 1", e:"‚õèÔ∏èüè≠üñ§", c:"Kannada movie"},
  {t:"Vikrant Rona", e:"üåßÔ∏èüïµÔ∏èüå¥", c:"Kannada movie"},
  {t:"Garuda Gamana Vrishabha Vahana", e:"ü¶öüêÇüèôÔ∏è", c:"Kannada movie"},
  {t:"Kabzaa", e:"üï∂Ô∏èüö¨üí£", c:"Kannada movie"},
  {t:"Yuvarathnaa", e:"üè´üí™üéì", c:"Kannada movie"},
  {t:"Roberrt", e:"üçΩÔ∏èüôèüî´", c:"Kannada movie"},
  {t:"Love Mocktail 2", e:"‚òï‚ù§Ô∏èüé∂", c:"Kannada movie"},
  {t:"Rathnan Prapancha", e:"üß≥üåèüòÇ", c:"Kannada movie"},
  {t:"Hostel Hudugaru Bekagiddare", e:"üè®üë¨üòÇ", c:"Kannada movie"},
  {t:"Toby", e:"üé®üî™üåßÔ∏è", c:"Kannada movie"},
  {t:"Tagaru", e:"üêØüî´üö®", c:"Kannada movie"},
  {t:"Bell Bottom", e:"üïµÔ∏èüìªüìº", c:"Kannada movie"},
  {t:"Birbal Trilogy Case 1", e:"‚öñÔ∏èüïµÔ∏è‚Äç‚ôÇÔ∏èüß©", c:"Kannada movie"},
  {t:"Avane Srimannarayana", e:"ü§†üó∫Ô∏èüí∞", c:"Kannada movie"},
  {t:"Dia", e:"üíîüììüåßÔ∏è", c:"Kannada movie"},
  {t:"Sapta Sagaradaache Ello: Side A", e:"üåäüíëüéß", c:"Kannada movie"},
  {t:"Sapta Sagaradaache Ello: Side B", e:"üåäüíîüéß", c:"Kannada movie"},
  {t:"Kirik Party", e:"üéìüéâüíò", c:"Kannada movie"},
  {t:"Charlie 777", e:"üê∂üêïüôéüèΩ‚Äç‚ôÇÔ∏èüóª", c:"Kannada movie"},
  {t:"Godhi Banna Sadharana Mykattu", e:"üßìüß†üß£", c:"Kannada movie"},

  /* Telugu (existing) */
  {t:"Kalki 2898 AD", e:"ü§ñüõïüåå‚öîÔ∏è", c:"Telugu movie"},
  {t:"RRR (Tel)", e:"ü§ùüî•üåßÔ∏è", c:"Telugu movie"},
  {t:"Pushpa: The Rise", e:"üå≤üíºüßî‚Äç‚ôÇÔ∏èüï∂Ô∏èüå∏üå∏üå∏", c:"Telugu movie"},
  /* Telugu (+20) */
  {t:"Salaar: Part 1 ‚Äì Ceasefire", e:"üñ§‚öîÔ∏èüöÇ", c:"Telugu movie"},
  {t:"Hanu-Man", e:"ü¶∏‚Äç‚ôÇÔ∏èü™ô‚ö°", c:"Telugu movie"},
  {t:"Sita Ramam", e:"üíåüë∏üèΩü™ñüëÆüèΩ‚úâÔ∏èüõïüïå‚ùÑÔ∏è", c:"Telugu movie"},
  {t:"Dasara", e:"üåæüöÇüî•", c:"Telugu movie"},
  {t:"Ala Vaikunthapurramuloo", e:"üè†üíºüï∫üèΩüíÉüöÅüèØ", c:"Telugu movie"},
  {t:"Sarkaru Vaari Paata", e:"üí∞üî´üí≥", c:"Telugu movie"},
  {t:"Hi Nanna", e:"üë®‚Äçüëßü§Øüß†üêïüèñÔ∏èüßëüèª‚Äç‚ù§Ô∏è‚Äçüë©üèª‚ù§Ô∏è", c:"Telugu movie"},
  {t:"Baby", e:"üìöüíîüéß", c:"Telugu movie"},
  {t:"Pokiri", e:"üëÆüèΩüî´üï∫üèΩüíÉüèΩ‚öΩüö™üßëüèª‚Äç‚ù§Ô∏è‚Äçüë©üèªüí≥üë®üèΩ‚Äçüë©üèΩ‚ÄçüëßüèΩ‚Äçüë¶üèΩüë®üèΩ‚Äçüë©üèΩ‚ÄçüëßüèΩ‚Äçüë¶üèΩüë®üèΩ‚Äçüë©üèΩ‚ÄçüëßüèΩ‚Äçüë¶üèΩ", c:"Telugu movie"},
  {t:"Agent", e:"üï∂Ô∏èüî´üß®", c:"Telugu movie"},
  {t:"Jersey", e:"üèèüë®‚Äçüë¶üéñÔ∏è", c:"Telugu movie"},
  {t:"Baahubali: The Beginning", e:"üëëüèπüó°Ô∏èüí™üèΩüèØüèØüë¶üèΩüë¶üèΩüóªüé≠‚öîÔ∏èü§∫", c:"Telugu movie"},
  {t:"Baahubali 2: The Conclusion", e:"üëëüõ°Ô∏èüëëüèπüó°Ô∏èüí™üèΩüèØüèØüë¶üèΩüë¶üèΩüóªüé≠‚öîÔ∏èü§∫üêòüßëüèª‚Äç‚ù§Ô∏è‚Äçüë©üèªüíÄ", c:"Telugu movie"},
  {t:"Karthikeya 2", e:"üïâÔ∏èüîçüóùÔ∏è", c:"Telugu movie"},
  {t:"Taxiwaala", e:"üöïüëªüòÇ", c:"Telugu movie"},
  {t:"Tillu Square", e:"üéßüòéüíøüï∂Ô∏èüíÉüìÄ", c:"Telugu movie"},
  {t:"DJ Tillu", e:"üéßüòéüíø", c:"Telugu movie"},
  {t:"Majili", e:"üèèüíîüçª", c:"Telugu movie"},
  {t:"Evaru", e:"üïµÔ∏è‚Äç‚ôÇÔ∏èüî´ü©∏", c:"Telugu movie"},
  {t:"Goodachari", e:"üïµÔ∏è‚Äç‚ôÇÔ∏èüîçüõ∞Ô∏è", c:"Telugu movie"},

  /* Malayalam (existing) */
  {t:"Manjummel Boys", e:"üï≥Ô∏èüßó‚Äç‚ôÇÔ∏èüßë‚Äçü§ù‚Äçüßë", c:"Malayalam movie"},
  {t:"2018", e:"üåßÔ∏èüö§ü§ùüáÆüá≥", c:"Malayalam movie"},
  {t:"Premam", e:"‚ù§Ô∏èüéìüìñüç∫", c:"Malayalam movie"},
  /* Malayalam (+20) */
  {t:"Aavesham", e:"üï∫üî•üòé", c:"Malayalam movie"},
  {t:"Aadujeevitham (The Goat Life)", e:"üêêüèúÔ∏èüôè", c:"Malayalam movie"},
  {t:"Rorschach", e:"üñ§ü¶áü™û", c:"Malayalam movie"},
  {t:"Minnal Murali", e:"‚ö°ü¶∏‚Äç‚ôÇÔ∏èüéÑ", c:"Malayalam movie"},
  {t:"Kurup", e:"üï∂Ô∏è‚úàÔ∏èüí∞", c:"Malayalam movie"},
  {t:"Kumbalangi Nights", e:"üèùÔ∏èüë®‚Äçüë®‚Äçüë¶‚Äçüë¶‚ù§Ô∏è", c:"Malayalam movie"},
  {t:"Romancham", e:"üëªü™ÑüòÇ", c:"Malayalam movie"},
  {t:"Thallumaala", e:"üëäüéµüòé", c:"Malayalam movie"},
  {t:"Hridayam", e:"‚ù§Ô∏èüéìüé∂", c:"Malayalam movie"},
  {t:"Bheeshma Parvam", e:"üêüüî´üõê", c:"Malayalam movie"},
  {t:"Malik", e:"üïå‚öñÔ∏èüåä", c:"Malayalam movie"},
  {t:"Jana Gana Mana", e:"‚öñÔ∏èüéìüî•", c:"Malayalam movie"},
  {t:"Nayattu", e:"üöìüèÉ‚Äç‚ôÇÔ∏èüåí", c:"Malayalam movie"},
  {t:"C U Soon", e:"üì±üíîüîç", c:"Malayalam movie"},
  {t:"Joji", e:"üçéüó°Ô∏èüè°", c:"Malayalam movie"},
  {t:"Varathan", e:"üè°üòàüî´", c:"Malayalam movie"},
  {t:"Premalu", e:"üíïüòÇüç∞", c:"Malayalam movie"},
  {t:"Turbo", e:"üèçÔ∏èüíºüí•", c:"Malayalam movie"},
  {t:"Bramayugam", e:"üïØÔ∏èüï∏Ô∏èüñ§", c:"Malayalam movie"},
  {t:"Kannur Squad", e:"üëÆ‚Äç‚ôÇÔ∏èüöôüîç", c:"Malayalam movie"},

  /* Tamil (existing) */
  {t:"Vikram (2022)", e:"üï∂Ô∏èüî´üß™", c:"Tamil movie"},
  {t:"Jailer", e:"üóùÔ∏èüëëüßî‚Äç‚ôÇÔ∏è", c:"Tamil movie"},
  {t:"Leo", e:"üßäüêØüó°Ô∏è", c:"Tamil movie"},
  /* Tamil (+20) */
  {t:"Ponniyin Selvan: I", e:"üëëüó°Ô∏èüö¢", c:"Tamil movie"},
  {t:"Ponniyin Selvan: II", e:"üëë‚öîÔ∏èüåä", c:"Tamil movie"},
  {t:"Beast", e:"üêØüî´üè¢", c:"Tamil movie"},
  {t:"Maanaadu", e:"‚è±Ô∏èüîÅüî´", c:"Tamil movie"},
  {t:"Love Today", e:"‚ù§Ô∏èüì±üòÇ", c:"Tamil movie"},
  {t:"Doctor", e:"üë®‚Äç‚öïÔ∏èüò∂ü©∫", c:"Tamil movie"},
  {t:"Thunivu", e:"üè¶üî´üí∞", c:"Tamil movie"},
  {t:"Varisu", e:"üë®‚Äçüë©‚Äçüëß‚Äçüë¶üíºüéâ", c:"Tamil movie"},
  {t:"Kaithi", e:"üööüåôüî´", c:"Tamil movie"},
  {t:"Master", e:"üë®‚Äçüè´ü•äüìö", c:"Tamil movie"},
  {t:"Maaveeran", e:"üó°Ô∏èüó£Ô∏èü¶∏‚Äç‚ôÇÔ∏è", c:"Tamil movie"},
  {t:"Captain Miller", e:"üéñÔ∏èüå≤üí•", c:"Tamil movie"},
  {t:"Good Night", e:"üò¥üí§‚ù§Ô∏è", c:"Tamil movie"},
  {t:"Vada Chennai", e:"ü™ìüèôÔ∏èüéØ", c:"Tamil movie"},
  {t:"Asuran", e:"üåæü©∏ü™ì", c:"Tamil movie"},
  {t:"Soorarai Pottru", e:"‚úàÔ∏èüí°üí™", c:"Tamil movie"},
  {t:"Jai Bhim", e:"‚öñÔ∏èüïäÔ∏èüë®‚Äç‚öñÔ∏è", c:"Tamil movie"},
  {t:"Ayalaan", e:"üëΩüå±‚ú®", c:"Tamil movie"},
  {t:"Maamannan", e:"üêçüèõÔ∏èüé≠", c:"Tamil movie"},
  {t:"96", e:"üìº‚ù§Ô∏èüé∂", c:"Tamil movie"}
];

/* ===== UI refs ===== */
const emojiEl = document.getElementById('emoji');
const categoryEl = document.getElementById('category');
const progressEl = document.getElementById('progress');
const clockEl = document.getElementById('clock');
const hintEl = document.getElementById('hint');
const clapper = document.getElementById('clapper');
const titleEl = document.getElementById('movieTitle');

const btnReveal = document.getElementById('reveal');
const btnNext = document.getElementById('nextBtn');
const btnSkip = document.getElementById('skip');
const btnRestart = document.getElementById('restart');

const rulesBtn = document.getElementById('rulesBtn');
const rulesModal = document.getElementById('rulesModal');
const rulesClose = document.getElementById('rulesClose');

const musicBtn = document.getElementById('musicBtn');
const styleBtn = document.getElementById('styleBtn');
const shuffleBtn = document.getElementById('shuffleBtn');

const catsBtn = document.getElementById('catsBtn');
const catsModal = document.getElementById('catsModal');
const catsApply = document.getElementById('catsApply');
const catsCancel = document.getElementById('catsCancel');
const catsAll = document.getElementById('catsAll');
const catsNone = document.getElementById('catsNone');
const catsGrid = document.getElementById('catsGrid');
const activeCatsRow = document.getElementById('activeCats');

/* ===== Helpers ===== */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.random()*(i+1)|0; [a[i],a[j]]=[a[j],a[i]] } return a }
function uniq(a){ return Array.from(new Set(a)); }
const ALL_CATS = ["English movie","Hindi movie","Kannada movie","Telugu movie","Malayalam movie","Tamil movie"];
const LIMITS = [10,20,30];
const TIMERS = [10,12,15,20];

function getFilteredList(cats){
  return MOVIES
    .filter(m=>cats.includes(m.c))
    .filter(m=>m.e && m.t && m.t.indexOf("‚Ä¶ (already added)")===-1);
}
function langFromCategory(c){ return (c||'').replace(/\s*movie\s*$/i,''); }

/* ===== Strict unique session (1) ===== */
function buildOrderUnique(fullList, limit){
  const unique = uniq(fullList.map(x=>JSON.stringify(x))).map(s=>JSON.parse(s));
  const base = shuffle(unique);
  if(base.length < limit) return null; // not enough
  return base.slice(0, limit);
}

/* ===== Persistent selections ===== */
function loadSelectedCats(){
  try{ const v=JSON.parse(localStorage.getItem('emojiCats')); if(Array.isArray(v)&&v.length) return uniq(v).filter(x=>ALL_CATS.includes(x)); }catch(e){}
  return [...ALL_CATS];
}
function saveSelectedCats(cats){ localStorage.setItem('emojiCats', JSON.stringify(uniq(cats))); }
function loadLimit(){ const v=parseInt(localStorage.getItem('emojiLimit'),10); return LIMITS.includes(v)?v:30; }
function saveLimit(n){ localStorage.setItem('emojiLimit', String(n)); }
function loadTimer(){ const v=parseInt(localStorage.getItem('emojiTimer'),10); return TIMERS.includes(v)?v:12; }
function saveTimer(n){ localStorage.setItem('emojiTimer', String(n)); }

/* ===== Background edge lights & windows ===== */
const winLayer = document.querySelector('.windows');
const BG_EMOJIS = ["üé¨","üéüÔ∏è","üéûÔ∏è","üçø","‚≠ê","üéµ","üé≠","üé•","‚ú®","ü™©","üéâ","üéà"];
for(let i=0;i<100;i++){ const d=document.createElement('div'); d.className='win'; d.setAttribute('data-e', BG_EMOJIS[i%BG_EMOJIS.length]); winLayer.appendChild(d); }
const edge = document.getElementById('edgeLights'), ex = edge.getContext('2d');
function drawEdge(t=0){
  const dpr = devicePixelRatio||1;
  edge.width=innerWidth*dpr; edge.height=innerHeight*dpr; edge.style.width='100vw'; edge.style.height='100vh'; ex.setTransform(dpr,0,0,dpr,0,0);
  ex.clearRect(0,0,innerWidth,innerHeight);
  const cols=['#ffd400','#63f7ff','#ff79b0','#a6ff8f','#ffd1ff'];
  const bulb=(x,y,i)=>{ const pulse=(Math.sin(t/350+i)*.5+.5), r=4+pulse*2;
    ex.save(); ex.globalAlpha=.85; ex.fillStyle=cols[i%cols.length]; ex.shadowColor=cols[i%cols.length]; ex.shadowBlur=16+pulse*14;
    ex.beginPath(); ex.arc(x,y,r+2,0,Math.PI*2); ex.fill(); ex.restore();
    ex.beginPath(); ex.fillStyle=cols[i%cols.length]; ex.arc(x,y,r,0,Math.PI*2); ex.fill();
  };
  const s=36; let i=0;
  for(let x=8;x<innerWidth-8;x+=s){bulb(x,8,i++)} for(let x=8;x<innerWidth-8;x+=s){bulb(x,innerHeight-8,i++)}
  for(let y=8;y<innerHeight-8;y+=s){bulb(8,y,i++)} for(let y=8;y<innerHeight-8;y+=s){bulb(innerWidth-8,y,i++)}
  requestAnimationFrame(drawEdge);
}
requestAnimationFrame(drawEdge);

/* ===== Audio: background + whoosh + celebration (Soothing removed) ===== */
let audioCtx, musicOn=true, musicLoop=null, musicStyle=0;
const STYLES = ["Fun Beat","Playful Plucks"]; // removed "Soothing Chill"
function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
function startMusic(){
  if(!musicOn || musicLoop) return; ensureAudio();
  const master=audioCtx.createGain(); master.gain.value=.28; master.connect(audioCtx.destination);

  const beat = 60/108;
  let t0 = audioCtx.currentTime + 0.05;

  function scheduleFunBeat(){
    function kick(t){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.connect(g).connect(master);
      o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(55,t+.08);
      g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.8,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+.18);
      o.start(t); o.stop(t+.2);
    }
    function hat(t){ const n=audioCtx.createBufferSource(); const len=audioCtx.sampleRate*.05;
      const b=audioCtx.createBuffer(1,len,audioCtx.sampleRate), d=b.getChannelData(0);
      for(let i=0;i<len;i++) d[i]=(Math.random()*2-1)*Math.pow(1-i/len,1.2);
      n.buffer=b; const g=audioCtx.createGain(); g.gain.value=.06; n.connect(g).connect(master); n.start(t);
    }
    function bass(semi,t,d=.25){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sawtooth'; o.frequency.value=55*Math.pow(2,semi/12);
      o.connect(g).connect(master); g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.18,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+d);
      o.start(t); o.stop(t+d+.02);
    }
    function bar(t){ kick(t); hat(t); hat(t+0.5*beat); kick(t+2*beat); hat(t+2.5*beat);
      [0,0,-5,-5,2,2,0,0].forEach((st,i)=>bass(st,t+i*.5*beat,.24));
    }
    bar(t0);
    const dur=4*beat;
    const id=setInterval(()=>{ t0+=dur; bar(t0) }, dur*1000);
    musicLoop={id};
  }

  function schedulePlucks(){
    function pluck(freq,t,d=.24){
      const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='triangle';
      o.frequency.value=freq; o.connect(g).connect(master);
      g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(.14,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+d);
      o.start(t); o.stop(t+d+.02);
    }
    const scale=[440,494,523,587,659,698,784]; // A4->G5
    function bar(t){ for(let i=0;i<8;i++){ const f=scale[(i*2+3)%scale.length]; pluck(f,t+i*.5*beat);} }
    bar(t0);
    const dur=4*beat;
    const id=setInterval(()=>{ t0+=dur; bar(t0)}, dur*1000);
    musicLoop={id};
  }

  [scheduleFunBeat, schedulePlucks][musicStyle]();
}
function stopMusic(){ if(musicLoop){clearInterval(musicLoop.id); musicLoop=null;} }

document.addEventListener('click', function once(){ ensureAudio(); if(musicOn) startMusic(); document.removeEventListener('click', once); }, {once:true});
musicBtn.addEventListener('click', ()=>{ musicOn=!musicOn; musicBtn.textContent='Music: '+(musicOn?'On':'Off'); if(musicOn) startMusic(); else stopMusic(); });
styleBtn.addEventListener('click', ()=>{
  musicStyle = (musicStyle+1)%STYLES.length;
  styleBtn.textContent = 'Style: ' + STYLES[musicStyle];
  if(musicOn){ stopMusic(); startMusic(); }
});

function whoosh(){
  ensureAudio();
  const o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.type='sine'; o.frequency.setValueAtTime(220,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(880,audioCtx.currentTime+.25);
  g.gain.setValueAtTime(.0001,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.18,audioCtx.currentTime+.02);
  g.gain.exponentialRampToValueAtTime(.0001,audioCtx.currentTime+.28);
  o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+.3);
}

/* Soft, sober celebration chime */
function celebration(){
  ensureAudio(); if(!audioCtx) return;
  const master = audioCtx.createGain(); master.gain.value = 0.14; master.connect(audioCtx.destination);
  const t0 = audioCtx.currentTime + 0.02;
  const pad = audioCtx.createOscillator(), pg = audioCtx.createGain(); pad.type='sine'; pad.frequency.value=330;
  pg.gain.setValueAtTime(0.0001,t0); pg.gain.linearRampToValueAtTime(0.06,t0+0.06); pg.gain.exponentialRampToValueAtTime(0.0001,t0+1.1);
  pad.connect(pg).connect(master); pad.start(t0); pad.stop(t0+1.2);
  function ch(freq,when,d=0.22,p=0.22){ const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=freq;
    g.gain.setValueAtTime(0.0001,when); g.gain.linearRampToValueAtTime(p,when+0.02); g.gain.exponentialRampToValueAtTime(0.0001,when+d);
    o.connect(g).connect(master); o.start(when); o.stop(when+d+0.05); }
  ch(523.25,t0); ch(659.25,t0+0.08); ch(783.99,t0+0.16);
}

/* ===== Confetti ===== */
const cf = document.createElement('canvas'); cf.id='confettiLayer'; document.body.appendChild(cf);
cf.style.position='fixed'; cf.style.inset='0'; cf.style.pointerEvents='none'; cf.style.zIndex='8';
const cfx = cf.getContext('2d');
function sprinkle(){
  const dpr=devicePixelRatio||1; cf.width=innerWidth*dpr; cf.height=innerHeight*dpr; cf.style.width='100vw'; cf.style.height='100vh'; cfx.setTransform(dpr,0,0,dpr,0,0);
  const cx=innerWidth/2, cy=innerHeight/2;
  const parts=[]; const colors=['#ffd400','#63f7ff','#ff79b0','#a6ff8f','#ffd1ff'];
  for(let i=0;i<220;i++){
    const ang=Math.random()*Math.PI*2, spd=2+Math.random()*6;
    parts.push({x:cx,y:cy,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,g:.06+Math.random()*.08,r:2+Math.random()*2.5,c:colors[i%colors.length],a:1});
  }
  const start=performance.now();
  (function anim(now){
    const t=now-start;
    cfx.clearRect(0,0,innerWidth,innerHeight);
    parts.forEach(p=>{ p.vy+=p.g; p.x+=p.vx; p.y+=p.vy; p.a*=.985;
      cfx.globalAlpha=Math.max(0,p.a); cfx.fillStyle=p.c; cfx.beginPath(); cfx.arc(p.x,p.y,p.r,0,Math.PI*2); cfx.fill();
    });
    if(t<1400) requestAnimationFrame(anim); else cfx.clearRect(0,0,innerWidth,innerHeight);
  })(start);
}

/* ===== Game state ===== */
let order=[], idx=0, revealed=false, started=false;
let timer=null, timeLeft=12, lastSpaceTime=0;
let selectedCats = loadSelectedCats();
let selectedLimit = loadLimit();
let selectedTimer = loadTimer();

/* ===== Flow ===== */
function updateClock(){ clockEl.textContent="‚è±Ô∏è "+timeLeft+"s"; clockEl.style.background=timeLeft<=5?"rgba(255,123,123,.3)":"var(--glass2)"; }
function updateHint(){
  const m = order[idx];
  hintEl.textContent = "HINT: " + (m ? langFromCategory(m.c) : "‚Äî");
}
function startTimer(){
  clearInterval(timer); timeLeft=selectedTimer; updateClock();
  timer=setInterval(()=>{ 
    timeLeft--; updateClock();
    if(timeLeft<=0){ clearInterval(timer); showAnswer(false); /* no auto-next */ }
  }, 1000);
}
function showEmoji(){
  const m=order[idx]; emojiEl.textContent=m.e; progressEl.textContent=(idx+1)+" / "+order.length;
  updateHint();
  whoosh();
}
function showAnswer(){
  if(!started) return;
  if(revealed) return; revealed=true; clearInterval(timer);
  const m=order[idx]; titleEl.textContent=m.t; clapper.classList.add('show');
  sprinkle(); celebration();
}
function hideAnswer(){ revealed=false; clapper.classList.remove('show'); }
function next(){
  if(!started) return;
  hideAnswer(); idx++;
  if(idx>=order.length){ end(); return; }
  showEmoji(); startTimer();
}
function end(){
  emojiEl.textContent="üéâ All done!"; clockEl.textContent="‚è±Ô∏è ‚Äî";
  hintEl.textContent="HINT: ‚Äî";
  titleEl.textContent="Thanks for playing!"; clapper.classList.add('show');
}

/* ===== Init ===== */
function renderActiveChips(){
  activeCatsRow.innerHTML='';
  selectedCats.forEach(cat=>{
    const chip=document.createElement('div'); chip.className='chip'; chip.innerHTML=`${cat} <button aria-label="Remove ${cat}">√ó</button>`;
    chip.querySelector('button').addEventListener('click', ()=>{
      selectedCats = selectedCats.filter(c=>c!==cat);
      if(!selectedCats.length){ selectedCats=[...ALL_CATS]; }
      saveSelectedCats(selectedCats);
      if(started) init(selectedCats, selectedLimit, selectedTimer);
    });
    activeCatsRow.appendChild(chip);
  });
}
function init(withCats=selectedCats, withLimit=selectedLimit, withTimer=selectedTimer){
  selectedCats = (withCats && withCats.length) ? uniq(withCats) : [...ALL_CATS];
  selectedLimit = LIMITS.includes(+withLimit) ? +withLimit : 30;
  selectedTimer = TIMERS.includes(+withTimer) ? +withTimer : 12;
  saveSelectedCats(selectedCats); saveLimit(selectedLimit); saveTimer(selectedTimer);

  const list = getFilteredList(selectedCats);
  const built = buildOrderUnique(list, selectedLimit);
  if(!built){
    alert("Not enough movies in the selected languages for this round size.\nAdd more languages or choose a smaller round.");
    catsModal.style.display='flex'; started=false; return;
  }
  order = built;

  idx=0; hideAnswer(); showEmoji(); startTimer(); renderActiveChips(); started=true;
}

/* ===== Controls ===== */
btnReveal.addEventListener('click', ()=>showAnswer());
btnNext.addEventListener('click', ()=>{ hideAnswer(); next(); });
btnSkip.addEventListener('click', ()=>{ hideAnswer(); next(); });
btnRestart.addEventListener('click', ()=>{ catsModal.style.display='flex'; started=false; clearInterval(timer); });

document.addEventListener('keydown', (e)=>{
  if(e.code!=='Space') return;
  if(!started){ e.preventDefault(); return; }
  e.preventDefault();
  const now=performance.now();
  if(now - lastSpaceTime < 420){ hideAnswer(); next(); lastSpaceTime=0; } else { showAnswer(); lastSpaceTime=now; }
});

shuffleBtn.addEventListener('click', ()=>{ if(!started) return; init(selectedCats, selectedLimit, selectedTimer); });

/* ===== Rules modal ===== */
rulesBtn.addEventListener('click', ()=> rulesModal.style.display='flex');
rulesClose.addEventListener('click', ()=> rulesModal.style.display='none');
rulesModal.addEventListener('click', (e)=>{ if(e.target===rulesModal) rulesModal.style.display='none'; });

/* ===== Categories & Rounds modal (first thing) ===== */
function buildCatsGrid(){
  catsGrid.innerHTML='';
  ALL_CATS.forEach(cat=>{
    const label=document.createElement('label'); label.className='cat-item';
    const id='cat_'+cat.replace(/\s+/g,'_');
    label.innerHTML = `<input id="${id}" type="checkbox" class="cat" value="${cat}"/> <span>${cat}</span>`;
    catsGrid.appendChild(label);
  });
}
buildCatsGrid();
const catChecks = () => Array.from(document.querySelectorAll('.cat'));

catsBtn.addEventListener('click', openCats);
function openCats(){
  catsModal.style.display='flex';
  const saved = new Set(selectedCats);
  catChecks().forEach(cb=> cb.checked = saved.has(cb.value));
  const limitInputs = document.querySelectorAll('input[name="limit"]');
  limitInputs.forEach(r=> r.checked = (+r.value === selectedLimit));
  const timerInputs = document.querySelectorAll('input[name="timer"]');
  timerInputs.forEach(r=> r.checked = (+r.value === selectedTimer));
}
catsCancel.addEventListener('click', ()=> catsModal.style.display='none');
catsModal.addEventListener('click', (e)=>{ if(e.target===catsModal) catsModal.style.display='none'; });
catsAll.addEventListener('click', ()=> catChecks().forEach(cb=> cb.checked = true));
catsNone.addEventListener('click', ()=> catChecks().forEach(cb=> cb.checked = false));

catsApply.addEventListener('click', ()=>{
  const chosen = catChecks().filter(cb=>cb.checked).map(cb=>cb.value);
  if(!chosen.length){ alert('Pick at least one category.'); return; }
  const limit = +document.querySelector('input[name="limit"]:checked')?.value || selectedLimit;
  const timerSec = +document.querySelector('input[name="timer"]:checked')?.value || selectedTimer;
  catsModal.style.display='none';
  init(chosen, limit, timerSec);
  if(musicOn) startMusic();
});

/* ===== Boot: open the categories modal first ===== */
window.addEventListener('load', ()=>{ document.getElementById('clock').textContent='‚è±Ô∏è '+selectedTimer+'s'; document.getElementById('hint').textContent='HINT: ‚Äî'; catsModal.style.display='flex'; });
</script>
</body>
</html>


